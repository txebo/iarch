{
  "archinstall-language": "English",
  "version": "3.0.9",
  "hostname": "txedgevm",
  "bootloader": "Systemd-boot",
  "kernels": ["linux-lts", "linux"],
  "swap": true,
  "ntp": true,
  "timezone": "America/Monterrey",
  "locale_config": {
    "kb_layout": "es",
    "sys_lang": "en_US.UTF-8",
    "sys_enc": "UTF-8"
  },
  "disk_config": {
    "config_type": "default_layout",
    "device_modifications": [
      {
        "device": "/dev/sda",
        "wipe": true,
        "partitions": [
          {
            "status": "create",
            "type": "primary",
            "fs_type": "fat32",
            "flags": ["boot", "esp"],
            "mountpoint": "/boot",
            "size": "1GiB",
            "start": "1MiB"
          },
          {
            "status": "create",
            "type": "primary",
            "fs_type": "ext4",
            "mountpoint": "/",
            "size": "32GiB"
          },
          {
            "status": "create",
            "type": "primary",
            "fs_type": "ext4",
            "mountpoint": "/home",
            "size": "100%"
          }
        ]
      }
    ]
  },
  "packages": [
    "base","base-devel","linux-lts","linux","linux-firmware","linux-headers",
    "nano","git","jq","ca-certificates","reflector","pacman-contrib",
    "openssh","rsync","curl","wget","iputils","ethtool","ldns","net-tools",
    "NetworkManager","systemd-resolvconf",
    "hyperv","hyperv-daemons",
    "nftables","iptables-nft","fail2ban",
    "podman","podman-compose","netavark","aardvark-dns","slirp4netns","fuse-overlayfs","buildah","skopeo","podman-docker",
    "wireguard-tools",
    "zip","unzip","p7zip",
    "htop","tmux","bash-completion","nmap","tcpdump","lynis"
  ],
  "services": [
    "NetworkManager",
    "systemd-resolved",
    "sshd",
    "nftables",
    "fail2ban",
    "hyperv-daemons"
  ],
  "parallel_downloads": 10,
  "profile_config": {
    "profile": { "main": "Minimal", "details": [], "custom_settings": {} },
    "greeter": null,
    "gfx_driver": null
  },
  "auth_config": {},
  "app_config": null,
  "script": null,
  "custom_commands": [
    "ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf || true",
    "mkdir -p /etc/NetworkManager/system-connections /etc/NetworkManager/conf.d",
    "bash -lc 'cat >/etc/NetworkManager/conf.d/dns.conf <<EOF\\n[main]\\ndns=systemd-resolved\\nEOF'",
    "bash -lc 'cat >/etc/NetworkManager/system-connections/txedgevm.nmconnection <<EOF\\n[connection]\\nid=txedgevm-static\\ntype=ethernet\\nautoconnect=true\\n\\n[ipv4]\\naddress1=10.99.64.2/24,10.99.64.1\\ndns=1.1.1.1;8.8.8.8;\\nmethod=manual\\n\\n[ipv6]\\nmethod=ignore\\nEOF'",
    "chmod 600 /etc/NetworkManager/system-connections/txedgevm.nmconnection",
    "bash -lc 'cat >/etc/sysctl.d/99-txedgevm.conf <<EOF\\nnet.ipv4.ip_forward=1\\nnet.ipv4.conf.all.rp_filter=2\\nnet.ipv4.conf.default.rp_filter=2\\nEOF'",
    "bash -lc 'cat >/etc/fail2ban/jail.d/sshd.local <<EOF\\n[sshd]\\nenabled = true\\nfilter = sshd\\nbackend = systemd\\nport   = ssh\\nlogpath = %(sshd_log)s\\nmaxretry = 5\\nfindtime = 10m\\nbantime = 1h\\nignoreip = 127.0.0.1/8 ::1 10.99.64.1\\nEOF'",
    "bash -lc 'cat >/etc/nftables.conf <<\"EOF\"\\n#!/usr/bin/env nft -f\\nflush ruleset\\n\\n# Redes/hosts\\ndefine LAN_NET = 10.99.64.0/24\\ndefine HOST_WIN = 10.99.64.1\\n\\n# Tabla filtro (inet)\\ntable inet filter {\\n  chains {\\n    input {\\n      type filter hook input priority 0; policy drop;\\n      iifname lo accept\\n      ct state established,related accept\\n      meta l4proto icmp accept\\n      meta l4proto ipv6-icmp accept\\n      # SSH\\n      tcp dport 22 ct state new limit rate 15/minute accept\\n      # HTTP/HTTPS solo desde el host Windows (portproxy)\\n      tcp dport {80,443} ip saddr $HOST_WIN accept\\n      # (Opcional) Dashboard Traefik si lo expones\\n      tcp dport 8080 ip saddr $HOST_WIN accept\\n      counter drop\\n    }\\n    forward {\\n      type filter hook forward priority 0; policy drop;\\n      ct state established,related accept\\n      ip saddr $LAN_NET accept\\n    }\\n    output {\\n      type filter hook output priority 0; policy accept;\\n    }\\n  }\\n}\\n\\n# NAT IPv4\\ntable ip nat {\\n  chains {\\n    prerouting { type nat hook prerouting priority -100; }\\n    postrouting { type nat hook postrouting priority 100; ip saddr $LAN_NET masquerade; }\\n  }\\n}\\nEOF'",
    "systemctl enable --now systemd-resolved NetworkManager sshd nftables fail2ban hyperv-daemons || true",
    "sed -i 's/^#*\\(PermitRootLogin\\) .*/\\1 no/' /etc/ssh/sshd_config",
    "sed -i 's/^#*\\(PasswordAuthentication\\) .*/\\1 yes/' /etc/ssh/sshd_config",
    "systemctl restart sshd || true"
  ]
}
